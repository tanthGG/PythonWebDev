{% extends 'myapp/base.html' %}
{% load static %}

{% block myheader %}{% endblock myheader %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>

<section class="bg-gradient-to-br from-slate-100 via-white to-blue-50 dark:from-gray-900 dark:via-gray-900 dark:to-slate-900">
  <div class="mx-auto max-w-7xl px-4 py-16 sm:px-6 lg:px-8 lg:py-20">
    <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
      <div class="max-w-2xl space-y-3">
        <span class="inline-flex items-center gap-2 rounded-full bg-blue-600/10 px-4 py-1 text-sm font-medium text-blue-700 dark:bg-blue-500/10 dark:text-blue-200">
          Admin tools
        </span>
        <h1 class="text-4xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-5xl">User management</h1>
        <p class="text-lg text-gray-600 dark:text-gray-300">
          Onboard new riders, promote staff, and maintain accurate records with real-time feedback.
        </p>
      </div>
      <div class="flex items-center gap-3 self-start rounded-2xl border border-blue-100 bg-white px-5 py-4 text-sm font-medium text-blue-700 shadow-lg shadow-blue-200/40 dark:border-blue-500/30 dark:bg-gray-900 dark:text-blue-200 dark:shadow-blue-900/30">
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M12 6.75A2.25 2.25 0 1 0 12 2.25a2.25 2.25 0 0 0 0 4.5ZM4.5 20.118v-.243a4.875 4.875 0 0 1 4.875-4.875H9.75m4.5 0h.375a4.875 4.875 0 0 1 4.875 4.875v.243M17.25 8.25a2.25 2.25 0 1 1 0 4.5M6.75 10.5a2.25 2.25 0 1 1 0-4.5" />
        </svg>
        Manage your entire team
      </div>
    </div>

    <div class="mt-12 grid gap-8 lg:grid-cols-5">
      <div class="lg:col-span-3">
        <div class="overflow-hidden rounded-3xl border border-white/60 bg-white/95 shadow-2xl shadow-blue-200/30 backdrop-blur dark:border-white/10 dark:bg-gray-900/80 dark:shadow-blue-900/30">
          <div class="flex items-center justify-between border-b border-blue-50 px-6 py-4 dark:border-gray-800">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Existing users</h2>
            <span class="text-xs font-semibold uppercase tracking-wide text-gray-400 dark:text-gray-500">Click a row to edit</span>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 text-sm text-gray-700 dark:divide-gray-800 dark:text-gray-200" id="user-table">
              <thead class="bg-blue-50/70 text-xs font-semibold uppercase tracking-wide text-gray-600 dark:bg-gray-800 dark:text-gray-300">
                <tr>
                  <th scope="col" class="px-6 py-3">Username</th>
                  <th scope="col" class="px-6 py-3">Name</th>
                  <th scope="col" class="px-6 py-3">Email</th>
                  <th scope="col" class="px-6 py-3">Role</th>
                  <th scope="col" class="px-6 py-3">Points</th>
                  <th scope="col" class="px-6 py-3 text-right">Status</th>
                  <th scope="col" class="px-6 py-3 text-right">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 bg-white dark:divide-gray-800 dark:bg-gray-900"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="lg:col-span-2">
        <div class="overflow-hidden rounded-3xl border border-white/60 bg-white/95 shadow-2xl shadow-blue-200/30 backdrop-blur dark:border-white/10 dark:bg-gray-900/80 dark:shadow-blue-900/30">
          <div class="border-b border-blue-50 px-6 py-4 dark:border-gray-800">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white" id="user-form-title">Create new user</h2>
            <p class="text-xs text-gray-500 dark:text-gray-400">Fill in the details and press save. Toggle active and staff privileges as needed.</p>
          </div>
          <div class="px-6 py-6">
            <div id="form-alert" class="mb-4 hidden rounded-xl border px-4 py-3 text-sm" role="alert"></div>
            <form id="user-form" class="space-y-6" novalidate>
              {% csrf_token %}
              <input type="hidden" id="user-id" name="id">

              <div class="grid gap-4 md:grid-cols-2">
                <div>
                  <label for="user-username" class="mb-1 block text-sm font-semibold text-gray-600 dark:text-gray-300">Username</label>
                  <input type="text" id="user-username" name="username" class="block w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-800" required>
                </div>
                <div>
                  <label for="user-email" class="mb-1 block text-sm font-semibold text-gray-600 dark:text-gray-300">Email</label>
                  <input type="email" id="user-email" name="email" placeholder="user@example.com" class="block w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-800">
                </div>
                <div>
                  <label for="user-first-name" class="mb-1 block text-sm font-semibold text-gray-600 dark:text-gray-300">First name</label>
                  <input type="text" id="user-first-name" name="first_name" class="block w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-800">
                </div>
                <div>
                  <label for="user-last-name" class="mb-1 block text-sm font-semibold text-gray-600 dark:text-gray-300">Last name</label>
                  <input type="text" id="user-last-name" name="last_name" class="block w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-800">
                </div>
              </div>

              <div class="space-y-4">
                <div>
                  <label for="user-password" class="mb-1 block text-sm font-semibold text-gray-600 dark:text-gray-300">Password</label>
                  <input type="password" id="user-password" name="password" autocomplete="new-password" class="block w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-800">
                  <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">When editing a user, leave blank to keep the current password.</p>
                </div>
                <div class="grid gap-4 md:grid-cols-2">
                  <div>
                    <label for="user-usertype" class="mb-1 block text-sm font-semibold text-gray-600 dark:text-gray-300">User type</label>
                    <input type="text" id="user-usertype" name="usertype" placeholder="member / VIP / admin" class="block w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-800">
                  </div>
                  <div>
                    <label for="user-point" class="mb-1 block text-sm font-semibold text-gray-600 dark:text-gray-300">Points</label>
                    <input type="number" min="0" step="1" value="0" id="user-point" name="point" class="block w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-800">
                  </div>
                </div>
                <div class="flex flex-col gap-3 rounded-2xl border border-gray-200 bg-gray-50 px-4 py-3 dark:border-gray-700 dark:bg-gray-800">
                  <label class="inline-flex items-center gap-3 text-sm font-medium text-gray-700 dark:text-gray-200">
                    <input type="checkbox" id="user-is-active" name="is_active" checked class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:checked:bg-blue-500">
                    Active account
                  </label>
                  <label class="inline-flex items-center gap-3 text-sm font-medium text-gray-700 dark:text-gray-200">
                    <input type="checkbox" id="user-is-staff" name="is_staff" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:checked:bg-blue-500">
                    Staff privileges
                  </label>
                </div>
              </div>

              <div class="flex flex-wrap items-center justify-end gap-3">
                <button type="submit" class="inline-flex items-center rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-blue-600/40 transition hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-700" id="user-submit">
                  Create user
                </button>
                <button type="button" class="inline-flex items-center rounded-xl border border-gray-200 px-4 py-2 text-sm font-semibold text-gray-600 transition hover:bg-gray-100 dark:border-gray-700 dark:text-gray-200 dark:hover:bg-gray-800" id="user-reset">
                  Clear
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script id="initial-users-data" type="application/json">{{ initial_users_json|safe }}</script>

<script>
  (function () {
    const endpoints = {
      detail: "{% url 'ajax_user_detail' %}",
      create: "{% url 'ajax_user_create' %}",
      update: "{% url 'ajax_user_update' %}",
      delete: "{% url 'ajax_user_delete' %}"
    };

    const currentUserId = Number('{{ current_user_id|default:0 }}');
    const tableBody = document.querySelector('#user-table tbody');
    const form = document.getElementById('user-form');
    const formTitle = document.getElementById('user-form-title');
    const alertBox = document.getElementById('form-alert');
    const submitButton = document.getElementById('user-submit');
    const resetButton = document.getElementById('user-reset');

    const idInput = document.getElementById('user-id');
    const usernameInput = document.getElementById('user-username');
    const emailInput = document.getElementById('user-email');
    const firstNameInput = document.getElementById('user-first-name');
    const lastNameInput = document.getElementById('user-last-name');
    const passwordInput = document.getElementById('user-password');
    const userTypeInput = document.getElementById('user-usertype');
    const pointInput = document.getElementById('user-point');
    const isActiveInput = document.getElementById('user-is-active');
    const isStaffInput = document.getElementById('user-is-staff');

    let activeRowId = null;

    const csrftoken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;

    const showMessage = (message, type = 'success') => {
      const styles = {
        success: 'border-emerald-200 bg-emerald-50 text-emerald-700 dark:border-emerald-500/40 dark:bg-emerald-900/40 dark:text-emerald-200',
        danger: 'border-red-200 bg-red-50 text-red-700 dark:border-red-500/40 dark:bg-red-900/40 dark:text-red-200',
        info: 'border-blue-200 bg-blue-50 text-blue-700 dark:border-blue-500/40 dark:bg-blue-900/40 dark:text-blue-200'
      };
      alertBox.textContent = message;
      alertBox.className = `mb-4 rounded-xl border px-4 py-3 text-sm ${styles[type] || styles.success}`;
    };

    const clearMessage = () => {
      alertBox.textContent = '';
      alertBox.className = 'mb-4 hidden rounded-xl border px-4 py-3 text-sm';
    };

    const emptyCell = () => {
      const cell = document.createElement('td');
      cell.textContent = '-';
      cell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-400', 'dark:text-gray-500');
      return cell;
    };

    const renderStatusBadge = (isActive) => {
      const badge = document.createElement('span');
      badge.className = `inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold ${isActive ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-200' : 'bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-300'}`;
      const dot = document.createElement('span');
      dot.className = 'h-2 w-2 rounded-full';
      dot.style.backgroundColor = isActive ? '#22c55e' : '#9ca3af';
      badge.appendChild(dot);
      badge.appendChild(document.createTextNode(isActive ? 'Active' : 'Inactive'));
      return badge;
    };

    const setActiveRow = (userId) => {
      if (activeRowId) {
        const previous = tableBody.querySelector(`tr[data-user-id="${activeRowId}"]`);
        if (previous) {
          previous.classList.remove('bg-blue-50/60', 'dark:bg-gray-800');
        }
      }
      if (userId) {
        const row = tableBody.querySelector(`tr[data-user-id="${userId}"]`);
        if (row) {
          row.classList.add('bg-blue-50/60', 'dark:bg-gray-800');
        }
      }
      activeRowId = userId || null;
    };

    const sortRows = () => {
      const rows = Array.from(tableBody.querySelectorAll('tr'));
      rows.sort((a, b) => a.dataset.username.localeCompare(b.dataset.username));
      rows.forEach((row) => tableBody.appendChild(row));
    };

    const removeRow = (userId) => {
      const row = tableBody.querySelector(`tr[data-user-id="${userId}"]`);
      if (row) {
        row.remove();
      }
    };

    const buildRow = (user) => {
      const row = document.createElement('tr');
      row.dataset.userId = user.id;
      row.dataset.username = user.username || '';
      row.dataset.firstName = user.first_name || '';
      row.dataset.lastName = user.last_name || '';
      row.dataset.email = user.email || '';
      row.dataset.usertype = user.usertype || '';
      row.dataset.point = user.point !== null && user.point !== undefined ? user.point : '';
      row.dataset.isActive = user.is_active ? 'true' : 'false';
      row.dataset.isStaff = user.is_staff ? 'true' : 'false';
      row.dataset.isSuperuser = user.is_superuser ? 'true' : 'false';
      row.className = 'transition hover:bg-blue-50/40 dark:hover:bg-gray-800';

      const usernameCell = document.createElement('td');
      usernameCell.className = 'px-6 py-4 text-sm font-semibold text-gray-900 dark:text-white';
      usernameCell.textContent = user.username || '';
      row.appendChild(usernameCell);

      if (user.first_name || user.last_name) {
        const nameCell = document.createElement('td');
        nameCell.className = 'px-6 py-4 text-sm text-gray-600 dark:text-gray-300';
        nameCell.textContent = `${user.first_name || ''} ${user.last_name || ''}`.trim();
        row.appendChild(nameCell);
      } else {
        row.appendChild(emptyCell());
      }

      if (user.email) {
        const emailCell = document.createElement('td');
        emailCell.className = 'px-6 py-4 text-sm';
        const emailLink = document.createElement('a');
        emailLink.href = `mailto:${user.email}`;
        emailLink.className = 'text-blue-600 hover:text-blue-700 dark:text-blue-300 dark:hover:text-blue-200';
        emailLink.textContent = user.email;
        emailCell.appendChild(emailLink);
        row.appendChild(emailCell);
      } else {
        row.appendChild(emptyCell());
      }

      const roleCell = document.createElement('td');
      roleCell.className = 'px-6 py-4 text-sm text-gray-600 dark:text-gray-300';
      let roleLabel = 'Member';
      if (user.is_superuser) {
        roleLabel = 'Superuser';
      } else if (user.is_staff) {
        roleLabel = 'Staff';
      } else if (user.usertype) {
        roleLabel = user.usertype;
      }
      roleCell.textContent = roleLabel;
      row.appendChild(roleCell);

      const pointsCell = document.createElement('td');
      pointsCell.className = 'px-6 py-4 text-sm text-gray-600 dark:text-gray-300';
      pointsCell.textContent = user.point !== null && user.point !== undefined ? user.point : '0';
      row.appendChild(pointsCell);

      const statusCell = document.createElement('td');
      statusCell.className = 'px-6 py-4 text-right';
      statusCell.appendChild(renderStatusBadge(Boolean(user.is_active)));
      row.appendChild(statusCell);

      const actionsCell = document.createElement('td');
      actionsCell.className = 'px-6 py-4 text-right';

      const editButton = document.createElement('button');
      editButton.type = 'button';
      editButton.className = 'inline-flex items-center rounded-full border border-blue-200 px-3 py-1 text-xs font-semibold text-blue-600 transition hover:bg-blue-50 dark:border-blue-500/40 dark:text-blue-300 dark:hover:bg-blue-500/10';
      editButton.textContent = 'Edit';
      editButton.addEventListener('click', () => editUser(user.id));
      actionsCell.appendChild(editButton);

      if (String(user.id) !== String(currentUserId)) {
        const deleteButton = document.createElement('button');
        deleteButton.type = 'button';
        deleteButton.className = 'ml-2 inline-flex items-center rounded-full border border-red-200 px-3 py-1 text-xs font-semibold text-red-600 transition hover:bg-red-50 dark:border-red-500/40 dark:text-red-200 dark:hover:bg-red-500/10';
        deleteButton.textContent = 'Delete';
        deleteButton.addEventListener('click', () => deleteUser(user.id));
        actionsCell.appendChild(deleteButton);
      }

      row.appendChild(actionsCell);
      return row;
    };

    const upsertRow = (user) => {
      const existingRow = tableBody.querySelector(`tr[data-user-id="${user.id}"]`);
      if (existingRow) {
        existingRow.remove();
      }
      tableBody.appendChild(buildRow(user));
      sortRows();
    };

    const fillForm = (user) => {
      idInput.value = user.id || '';
      usernameInput.value = user.username || '';
      emailInput.value = user.email || '';
      firstNameInput.value = user.first_name || '';
      lastNameInput.value = user.last_name || '';
      userTypeInput.value = user.usertype || '';
      pointInput.value = user.point !== null && user.point !== undefined ? user.point : '0';
      isActiveInput.checked = Boolean(user.is_active);
      isStaffInput.checked = Boolean(user.is_staff);
      passwordInput.value = '';

      setActiveRow(user.id);
      formTitle.textContent = `Update ${user.username}`;
      submitButton.textContent = 'Update user';
      submitButton.classList.remove('bg-blue-600');
      submitButton.classList.add('bg-indigo-600');
    };

    const resetForm = () => {
      form.reset();
      idInput.value = '';
      userTypeInput.value = '';
      pointInput.value = '0';
      isActiveInput.checked = true;
      isStaffInput.checked = false;

      setActiveRow(null);
      formTitle.textContent = 'Create new user';
      submitButton.textContent = 'Create user';
      submitButton.classList.remove('bg-indigo-600');
      submitButton.classList.add('bg-blue-600');
    };

    const handleError = (response) => {
      return response.json().then((data) => {
        throw new Error(data.error || 'Request failed');
      });
    };

    const editUser = (userId) => {
      const formData = new FormData();
      formData.append('id', userId);

      fetch(endpoints.detail, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken
        },
        body: formData
      })
        .then((response) => {
          if (!response.ok) {
            return handleError(response);
          }
          return response.json();
        })
        .then((data) => {
          if (!data || !data.user) {
            return;
          }
          fillForm(data.user);
          showMessage('User loaded. Make changes and press "Update user".', 'info');
        })
        .catch(() => {
          showMessage('Unable to load user details.', 'danger');
        });
    };

    const deleteUser = (userId) => {
      if (!confirm('Are you sure you want to delete this user?')) {
        return;
      }

      const formData = new FormData();
      formData.append('id', userId);

      fetch(endpoints.delete, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken
        },
        body: formData
      })
        .then((response) => {
          if (!response.ok) {
            return handleError(response);
          }
          return response.json();
        })
        .then((data) => {
          if (!data || !data.deleted) {
            return;
          }
          removeRow(userId);
          if (String(idInput.value) === String(userId)) {
            resetForm();
          }
          showMessage('User deleted successfully.', 'success');
        })
        .catch(() => {
          showMessage('Unable to delete user.', 'danger');
        });
    };

    const prepareFormData = (isUpdate) => {
      const formData = new FormData(form);

      if (isUpdate) {
        formData.set('id', idInput.value);
      } else {
        formData.delete('id');
      }

      formData.set('is_active', isActiveInput.checked ? 'true' : 'false');
      formData.set('is_staff', isStaffInput.checked ? 'true' : 'false');
      formData.set('point', pointInput.value || '0');

      if (!passwordInput.value) {
        formData.delete('password');
      }

      return formData;
    };

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      clearMessage();

      const isUpdate = Boolean(idInput.value);
      const formData = prepareFormData(isUpdate);
      const url = isUpdate ? endpoints.update : endpoints.create;

      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken
        },
        body: formData
      })
        .then((response) => {
          if (!response.ok) {
            return handleError(response);
          }
          return response.json();
        })
        .then((data) => {
          if (!data || !data.user) {
            return;
          }
          upsertRow(data.user);
          if (isUpdate) {
            fillForm(data.user);
            showMessage('User updated successfully.', 'success');
          } else {
            resetForm();
            showMessage('User created successfully.', 'success');
          }
        })
        .catch(() => {
          showMessage('Unable to save user.', 'danger');
        });
    });

    resetButton.addEventListener('click', () => {
      resetForm();
    });

    form.addEventListener('reset', () => {
      clearMessage();
    });

    const initialUsersScript = document.getElementById('initial-users-data');
    if (initialUsersScript) {
      const initialUsers = JSON.parse(initialUsersScript.textContent);
      initialUsers.forEach((user) => upsertRow(user));
      sortRows();
    }
  })();
</script>
{% endblock content %}
