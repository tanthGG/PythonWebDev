{% extends 'myapp/base.html' %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>

<section class="bg-gradient-to-br from-sky-100 via-white to-blue-50 dark:from-gray-900 dark:via-gray-900 dark:to-slate-900 py-16">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl space-y-4 mb-12">
      {% if admin_booking_mode %}
      <span class="inline-flex items-center gap-2 rounded-full bg-purple-600/10 px-4 py-1 text-sm font-medium text-purple-700 dark:bg-purple-500/10 dark:text-purple-200">Walk-in booking</span>
      <h1 class="text-4xl font-extrabold text-gray-900 dark:text-white sm:text-5xl">Create a walk-in ATV booking</h1>
      <p class="text-lg text-gray-600 dark:text-gray-300">Fill in the guest details, select the programs they want to ride, and we’ll save the booking so the operations team can prepare.</p>
      {% else %}
      <span class="inline-flex items-center gap-2 rounded-full bg-blue-600/10 px-4 py-1 text-sm font-medium text-blue-700 dark:bg-blue-500/10 dark:text-blue-200">Reserve your ride</span>
      <h1 class="text-4xl font-extrabold text-gray-900 dark:text-white sm:text-5xl">Book your Phuket ATV adventure</h1>
      <p class="text-lg text-gray-600 dark:text-gray-300">Tell us who is riding, pick the experiences that fit your group, and we’ll lock it in. All pricing is shown per person and the total is calculated automatically.</p>
      {% endif %}
    </div>

    {% if admin_booking_mode %}
    <div class="mb-10 flex flex-wrap items-center gap-3">
      <a href="{% url 'booking-list-page' %}" class="inline-flex items-center gap-2 rounded-full border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-800 transition hover:bg-gray-100 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-gray-700">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V5a3 3 0 0 1 3-3h2a3 3 0 0 1 3 3v2m4 0H4m16 0v11a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7m16 0l-2 13m-12 0L4 7" />
        </svg>
        View all bookings
      </a>
      <span class="text-sm text-gray-500 dark:text-gray-400">All fields marked with * are required for the confirmation email.</span>
    </div>
    {% endif %}

    <!-- Success alert -->
    {% if success_booking %}
    <div class="mb-10 rounded-3xl border border-emerald-200 bg-emerald-50 px-6 py-6 shadow-lg dark:border-emerald-500/30 dark:bg-emerald-900/30">
      {% if admin_booking_mode %}
      <h2 class="text-xl font-semibold text-emerald-800 dark:text-emerald-200">Booked for {{ success_booking.full_name }}.</h2>
      <p class="mt-2 text-sm text-emerald-700 dark:text-emerald-200">This walk-in has been saved. Share the summary with the guest and remind the team if transfers are required.</p>
      {% else %}
      <h2 class="text-xl font-semibold text-emerald-800 dark:text-emerald-200">Thanks {{ success_booking.full_name }}! Your request has been received.</h2>
      <p class="mt-2 text-sm text-emerald-700 dark:text-emerald-200">We’ll confirm the schedule via email shortly.</p>
      {% endif %}
      <div class="mt-4 overflow-hidden rounded-2xl bg-white/90 shadow dark:bg-gray-900/80">
        <div class="grid gap-4 border-b border-gray-100 px-5 py-4 text-sm dark:border-gray-800">
          <p><span class="font-semibold text-gray-900 dark:text-white">Ride date:</span> {{ success_booking.ride_date }}{% if success_booking.ride_time %} ({{ success_booking.get_ride_time_display }}){% endif %}</p>
          <p><span class="font-semibold text-gray-900 dark:text-white">Pickup place:</span> {{ success_booking.pickup_place|default:"—" }}</p>
          <p><span class="font-semibold text-gray-900 dark:text-white">Total amount:</span> {{ success_booking.total_amount|floatformat:0 }} THB</p>
        </div>
        <div class="p-5">
          <h3 class="text-sm font-semibold text-gray-900 dark:text-white uppercase tracking-wide">Summary</h3>
          <div class="mt-3 overflow-hidden rounded-xl border border-gray-200 dark:border-gray-700">
            <table class="min-w-full divide-y divide-gray-200 text-sm dark:divide-gray-700">
              <thead class="bg-gray-50 dark:bg-gray-800 text-gray-500 uppercase text-xs">
                <tr>
                  <th class="px-4 py-2 text-left">Program</th>
                  <th class="px-4 py-2 text-left">Type</th>
                  <th class="px-4 py-2 text-left">Age</th>
                  <th class="px-4 py-2 text-right">Qty</th>
                  <th class="px-4 py-2 text-right">Unit price</th>
                  <th class="px-4 py-2 text-right">Line total</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 bg-white dark:divide-gray-800 dark:bg-gray-900">
                {% for item in success_booking.items.all %}
                <tr>
                  <td class="px-4 py-2 text-gray-900 dark:text-gray-100">{{ item.program.name }}</td>
                  <td class="px-4 py-2">{{ item.get_participant_type_display }}</td>
                  <td class="px-4 py-2">{{ item.get_age_group_display }}</td>
                  <td class="px-4 py-2 text-right">{{ item.quantity }}</td>
                  <td class="px-4 py-2 text-right">{{ item.unit_price|floatformat:0 }} THB</td>
                  <td class="px-4 py-2 text-right font-semibold">{{ item.line_total|floatformat:0 }} THB</td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="px-4 py-4 text-center text-gray-500 dark:text-gray-400">No line items.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% if admin_booking_mode %}
      <div class="mt-6 flex flex-wrap justify-center gap-3">
        <a href="{% url 'admin-booking-create' %}" class="inline-flex items-center rounded-full bg-purple-600 px-5 py-2 text-sm font-semibold text-white shadow-lg shadow-purple-600/30 transition hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-200 dark:focus:ring-purple-800">
          Create another
        </a>
        <a href="{% url 'booking-list-page' %}" class="inline-flex items-center rounded-full border border-gray-300 px-5 py-2 text-sm font-semibold text-gray-800 transition hover:bg-gray-100 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-gray-700">
          View all bookings
        </a>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Error alert -->
    {% if errors %}
    <div class="mb-8 rounded-3xl border border-red-200 bg-red-50 px-6 py-5 text-sm text-red-700 shadow dark:border-red-500/30 dark:bg-red-900/30">
      <p class="font-semibold">Please fix the following:</p>
      <ul class="list-disc pl-5 mt-2 space-y-1">
        {% for error in errors %}<li>{{ error }}</li>{% endfor %}
      </ul>
    </div>
    {% endif %}

    <form method="post" class="space-y-12">
      {% csrf_token %}

      <!-- Customer & schedule section -->
      <div class="grid gap-6 rounded-3xl border border-white/60 bg-white/90 p-8 shadow-xl shadow-blue-200/40 backdrop-blur dark:border-white/10 dark:bg-gray-900/80 dark:shadow-blue-900/30 lg:grid-cols-2">
        <div class="space-y-4">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Rider details</h2>
          <div>
            <label for="full_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Full name*</label>
            <input id="full_name" name="full_name" type="text" value="{{ form_values.full_name|default:'' }}" class="mt-1 block w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white" required>
          </div>
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email*</label>
            <input id="email" name="email" type="email" value="{{ form_values.email|default:'' }}" class="mt-1 block w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white" required>
          </div>
          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Phone / WhatsApp*</label>
            <input id="phone" name="phone" type="tel" value="{{ form_values.phone|default:'' }}" class="mt-1 block w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white" required>
          </div>
        </div>
        <div class="space-y-4">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Schedule</h2>
          <div>
            <label for="ride_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Preferred date*</label>
            <input id="ride_date" name="ride_date" type="date" value="{{ form_values.ride_date|default:'' }}" class="mt-1 block w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white" required>
          </div>
          <div>
            <label for="ride_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Preferred time</label>
            <select id="ride_time" name="ride_time" class="mt-1 block w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white">
              <option value="">Any time</option>
              {% for value, label in ride_slots %}
              <option value="{{ value }}" {% if form_values.ride_time == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="pickup_place" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Pickup place</label>
            <textarea id="pickup_place" name="pickup_place" rows="2" class="mt-1 block w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white">{{ form_values.pickup_place|default:'' }}</textarea>
          </div>
          <div>
            <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notes</label>
            <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full rounded-xl border border-gray-200 px-4 py-2.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white">{{ form_values.notes|default:'' }}</textarea>
          </div>
        </div>
      </div>

      <!-- Program selection -->
      <div class="space-y-10">
        <div class="rounded-3xl border border-dashed border-purple-300/80 bg-white/80 p-6 shadow-sm dark:border-purple-500/30 dark:bg-gray-900/60">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Choose the program</h2>
          <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">
            {% if admin_booking_mode %}
            Add the first trail, set riders and passengers, then click add again if this guest booked another program.
            {% else %}
            Pick the ride you want first, adjust riders and passengers, then add another program if you’d like to stack experiences.
            {% endif %}
          </p>
          <div class="mt-4 flex flex-wrap items-end gap-3">
            <div class="flex flex-col">
              <label for="admin-program-select" class="text-sm font-medium text-gray-700 dark:text-gray-300">Program*</label>
              <select id="admin-program-select" class="mt-1 min-w-[220px] rounded-xl border border-gray-200 px-4 py-2 text-sm text-gray-900 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                <option value="">Select a program</option>
                {% for entry in program_entries %}
                <option value="{{ entry.program.id }}" {% if entry.is_active %}disabled{% endif %}>{{ entry.program.name }} ({{ entry.program.code }})</option>
                {% endfor %}
              </select>
            </div>
            <button type="button" id="admin-add-program" class="inline-flex items-center rounded-full bg-purple-600 px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-300 dark:focus:ring-purple-800">Add program</button>
            <span class="text-xs text-gray-500 dark:text-gray-400">Already added programs are disabled in the list.</span>
          </div>
        </div>

        <div id="admin-program-container" class="space-y-10">
          {% for entry in program_entries %}
          {% with program=entry.program rider_rows=entry.rider_rows passenger_rows=entry.passenger_rows %}
          <div class="admin-program-block rounded-3xl border border-white/60 bg-white/90 p-8 shadow-xl shadow-purple-200/30 backdrop-blur dark:border-white/10 dark:bg-gray-900/80 dark:shadow-purple-900/30 {% if not entry.is_active %}hidden{% endif %}" data-program-id="{{ program.id }}">
            <input type="hidden" name="active_program" value="{{ program.id }}" class="active-program-input" {% if not entry.is_active %}disabled{% endif %}>
            <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
              <div>
                <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">{{ program.name }}</h3>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Code: {{ program.code }} • Duration: {{ program.duration_minutes }} minutes</p>
                {% if program.description %}<p class="mt-2 text-sm text-gray-600 dark:text-gray-300">{{ program.description }}</p>{% endif %}
              </div>
              <div class="flex flex-col items-end gap-2 text-sm text-blue-700 dark:text-blue-300">
                <p>Total for this program is calculated automatically.</p>
                <div class="flex gap-2">
                  <button type="button" data-clear-program="{{ program.id }}" class="rounded-full border border-blue-200 px-4 py-1 text-sm font-medium text-blue-600 transition hover:bg-blue-50 dark:border-blue-500/40 dark:text-blue-200 dark:hover:bg-blue-900/30">Clear counts</button>
                  <button type="button" data-remove-program="{{ program.id }}" class="rounded-full border border-gray-200 px-4 py-1 text-sm font-medium text-gray-600 transition hover:bg-gray-100 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-800">Remove</button>
                </div>
              </div>
            </div>

            <div class="mt-6 grid gap-6 md:grid-cols-2">
              <div class="rounded-2xl border border-gray-200 bg-yellow-50/60 shadow-sm dark:border-gray-700 dark:bg-gray-800/60">
                <div class="border-b border-gray-200 px-4 py-3 text-lg font-semibold text-gray-900 dark:border-gray-700 dark:text-white">Rider</div>
                <div class="overflow-hidden">
                  <table class="min-w-full divide-y divide-gray-200 text-sm dark:divide-gray-700">
                    <thead class="bg-yellow-100 text-gray-600 uppercase text-xs dark:bg-gray-900 dark:text-gray-300">
                      <tr>
                        <th class="px-4 py-2 text-left">Age</th>
                        <th class="px-4 py-2 text-right">Price</th>
                        <th class="px-4 py-2 text-right">Qty</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 bg-white dark:divide-gray-800 dark:bg-gray-900">
                      {% for row in rider_rows %}
                      <tr>
                        <td class="px-4 py-3 font-medium text-gray-900 dark:text-gray-100">{{ row.age_label }}</td>
                        <td class="px-4 py-3 text-right text-blue-600 dark:text-blue-300 font-semibold">{% if row.price %}{{ row.price|floatformat:0 }} THB{% else %}-{% endif %}</td>
                        <td class="px-4 py-3 text-right">
                          <input type="number" min="0" {% if not row.price or not entry.is_active %}disabled{% endif %}
                                 name="{{ row.field }}"
                                 value="{{ row.quantity }}"
                                 data-program="{{ program.name }}"
                                 data-program-code="{{ program.code }}"
                                 data-participant="{{ row.participant_label }}"
                                 data-age="{{ row.age_label }}"
                                 data-price="{% if row.price %}{{ row.price|floatformat:2 }}{% else %}0{% endif %}"
                                 class="booking-qty-input w-24 rounded-lg border border-gray-200 px-3 py-2 text-right text-sm text-gray-900 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="rounded-2xl border border-gray-200 bg-yellow-50/60 shadow-sm dark:border-gray-700 dark:bg-gray-800/60">
                <div class="border-b border-gray-200 px-4 py-3 text-lg font-semibold text-gray-900 dark:border-gray-700 dark:text-white">Passenger</div>
                <div class="overflow-hidden">
                  <table class="min-w-full divide-y divide-gray-200 text-sm dark:divide-gray-700">
                    <thead class="bg-yellow-100 text-gray-600 uppercase text-xs dark:bg-gray-900 dark:text-gray-300">
                      <tr>
                        <th class="px-4 py-2 text-left">Age</th>
                        <th class="px-4 py-2 text-right">Price</th>
                        <th class="px-4 py-2 text-right">Qty</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 bg-white dark:divide-gray-800 dark:bg-gray-900">
                      {% for row in passenger_rows %}
                      <tr>
                        <td class="px-4 py-3 font-medium text-gray-900 dark:text-gray-100">{{ row.age_label }}</td>
                        <td class="px-4 py-3 text-right text-blue-600 dark:text-blue-300 font-semibold">{% if row.price %}{{ row.price|floatformat:0 }} THB{% else %}-{% endif %}</td>
                        <td class="px-4 py-3 text-right">
                          <input type="number" min="0" {% if not row.price or not entry.is_active %}disabled{% endif %}
                                 name="{{ row.field }}"
                                 value="{{ row.quantity }}"
                                 data-program="{{ program.name }}"
                                 data-program-code="{{ program.code }}"
                                 data-participant="{{ row.participant_label }}"
                                 data-age="{{ row.age_label }}"
                                 data-price="{% if row.price %}{{ row.price|floatformat:2 }}{% else %}0{% endif %}"
                                 class="booking-qty-input w-24 rounded-lg border border-gray-200 px-3 py-2 text-right text-sm text-gray-900 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          {% endwith %}
          {% empty %}
          <p class="text-gray-500 dark:text-gray-400">No programs are currently available for booking.</p>
          {% endfor %}
        </div>
      </div>

      <!-- Live summary -->
      <div class="space-y-4 rounded-3xl border border-white/60 bg-white/90 p-8 shadow-xl shadow-blue-200/30 backdrop-blur dark:border-white/10 dark:bg-gray-900/80 dark:shadow-blue-900/30">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Booking summary</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300">Adjust participant counts above and we’ll estimate your total right away.</p>
          </div>
          <button type="button" id="booking-clear-all" class="text-sm font-medium text-blue-600 hover:text-blue-700 dark:text-blue-300 dark:hover:text-blue-200">Reset all</button>
        </div>
        <div class="overflow-hidden rounded-2xl border border-gray-200 dark:border-gray-700">
          <table class="min-w-full divide-y divide-gray-200 text-sm dark:divide-gray-700">
            <thead class="bg-gray-50 text-xs font-semibold uppercase tracking-wide text-gray-600 dark:bg-gray-800 dark:text-gray-300">
              <tr>
                <th class="px-4 py-2 text-left">Program</th>
                <th class="px-4 py-2 text-left">Type</th>
                <th class="px-4 py-2 text-right">Qty</th>
                <th class="px-4 py-2 text-right">Unit</th>
                <th class="px-4 py-2 text-right">Line</th>
              </tr>
            </thead>
            <tbody id="booking-summary-body" class="divide-y divide-gray-100 bg-white dark:divide-gray-800 dark:bg-gray-900">
              <tr><td colspan="5" class="px-4 py-4 text-center text-sm text-gray-500 dark:text-gray-400">No selections yet.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="flex items-center justify-between text-lg font-semibold text-gray-900 dark:text-white">
          <span>Estimated total</span>
          <span id="booking-summary-total">0 THB</span>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400">Final confirmation, including transfers or extras, will be sent by our team after you submit.</p>
      </div>

      <div class="flex items-center justify-end gap-3">
        <button type="submit" class="inline-flex items-center rounded-full bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-blue-600/40 transition hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-700">Submit booking request</button>
      </div>
    </form>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const qtyInputs = Array.from(document.querySelectorAll('.booking-qty-input'));
    const summaryBody = document.getElementById('booking-summary-body');
    const summaryTotal = document.getElementById('booking-summary-total');
    const currency = new Intl.NumberFormat('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

    const addProgramBtn = document.getElementById('admin-add-program');
    if (addProgramBtn) {
      const programSelect = document.getElementById('admin-program-select');
      const programContainer = document.getElementById('admin-program-container');

      const highlightSelect = () => {
        programSelect.classList.add('ring-2', 'ring-offset-1', 'ring-red-400');
        setTimeout(() => programSelect.classList.remove('ring-2', 'ring-offset-1', 'ring-red-400'), 1500);
      };

      const enableBlock = (block) => {
        block.classList.remove('hidden');
        block.querySelectorAll('.booking-qty-input').forEach((input) => {
          if (parseFloat(input.dataset.price || '0') > 0) {
            input.disabled = false;
          }
        });
        const hiddenInput = block.querySelector('.active-program-input');
        if (hiddenInput) {
          hiddenInput.disabled = false;
        }
      };

      const disableBlock = (block) => {
        block.classList.add('hidden');
        block.querySelectorAll('.booking-qty-input').forEach((input) => {
          input.value = 0;
          input.disabled = true;
        });
        const hiddenInput = block.querySelector('.active-program-input');
        if (hiddenInput) {
          hiddenInput.disabled = true;
        }
      };

      const programOptions = programSelect ? Array.from(programSelect.querySelectorAll('option[value]')) : [];

      if (programContainer) {
        programContainer.querySelectorAll('.admin-program-block').forEach((block) => {
          if (block.classList.contains('hidden')) {
            disableBlock(block);
          } else {
            enableBlock(block);
            const programId = block.getAttribute('data-program-id');
            const option = programOptions.find((opt) => opt.value === programId);
            if (option) {
              option.disabled = true;
            }
          }
        });
      }

      addProgramBtn.addEventListener('click', () => {
        if (!programSelect || !programContainer) return;
        const programId = programSelect.value;
        if (!programId) {
          highlightSelect();
          return;
        }
        const block = programContainer.querySelector(`[data-program-id="${programId}"]`);
        if (!block) return;
        enableBlock(block);
        const option = programOptions.find((opt) => opt.value === programId);
        if (option) {
          option.disabled = true;
        }
        programSelect.value = '';
        updateSummary();
      });

      if (programSelect) {
        programSelect.addEventListener('change', () => {
          programSelect.classList.remove('ring-2', 'ring-offset-1', 'ring-red-400');
        });
      }

      if (programContainer) {
        programContainer.querySelectorAll('[data-remove-program]').forEach((button) => {
          button.addEventListener('click', () => {
            const programId = button.getAttribute('data-remove-program');
            const block = programContainer.querySelector(`[data-program-id="${programId}"]`);
            if (!block) return;
            disableBlock(block);
            const option = programOptions.find((opt) => opt.value === programId);
            if (option) {
              option.disabled = false;
            }
            updateSummary();
          });
        });
      }
    }

    function buildRow({ program, participant, age, quantity, unitPrice, lineTotal }) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="px-4 py-2 text-gray-900 dark:text-gray-100">${program}</td>
        <td class="px-4 py-2 text-gray-700 dark:text-gray-300">${participant} • ${age}</td>
        <td class="px-4 py-2 text-right">${quantity}</td>
        <td class="px-4 py-2 text-right">${currency.format(unitPrice)} THB</td>
        <td class="px-4 py-2 text-right font-semibold text-blue-600 dark:text-blue-300">${currency.format(lineTotal)} THB</td>
      `;
      return row;
    }

    function updateSummary() {
      let total = 0;
      summaryBody.innerHTML = '';

      qtyInputs.forEach((input) => {
        if (input.disabled) return;
        const qty = parseInt(input.value, 10) || 0;
        if (qty <= 0) return;

        const price = parseFloat(input.dataset.price || '0');
        const program = input.dataset.program || '';
        const participant = input.dataset.participant || '';
        const age = input.dataset.age || '';

        const line = price * qty;
        total += line;

        summaryBody.appendChild(
          buildRow({
            program,
            participant,
            age,
            quantity: qty,
            unitPrice: price,
            lineTotal: line,
          })
        );
      });

      if (!summaryBody.children.length) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = '<td colspan="5" class="px-4 py-4 text-center text-sm text-gray-500 dark:text-gray-400">No selections yet.</td>';
        summaryBody.appendChild(emptyRow);
      }

      summaryTotal.textContent = `${currency.format(total)} THB`;
    }

    qtyInputs.forEach((input) => {
      input.addEventListener('input', updateSummary);
      input.addEventListener('change', updateSummary);
    });

    document.querySelectorAll('[data-clear-program]').forEach((button) => {
      button.addEventListener('click', () => {
        const programId = button.getAttribute('data-clear-program');
        qtyInputs
          .filter((input) => input.name.endsWith(`_${programId}`))
          .forEach((input) => {
            if (!input.disabled) {
              input.value = 0;
            }
          });
        updateSummary();
      });
    });

    const clearAll = document.getElementById('booking-clear-all');
    if (clearAll) {
      clearAll.addEventListener('click', () => {
        qtyInputs.forEach((input) => {
          if (!input.disabled) {
            input.value = 0;
          }
        });
        updateSummary();
      });
    }

    updateSummary();
  });
</script>
{% endblock content %}
