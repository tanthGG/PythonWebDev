{% extends 'myapp/base.html' %}
{% load static %}

{% block myheader %}{% endblock myheader %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>

<section class="bg-gradient-to-br from-white via-[#F9F7C9]/60 to-[#AAD9BB]/30 py-16">
  <div class="mx-auto flex max-w-6xl flex-col gap-12 px-4 sm:px-6 lg:px-8">
    <header class="space-y-4 text-center lg:text-left">
      <span class="inline-flex items-center gap-2 rounded-full bg-white/80 px-4 py-1 text-sm font-semibold uppercase tracking-wide text-[#35605A] shadow-sm shadow-[#D5F0C1]/50">
        Team performance
      </span>
      <h1 class="text-3xl font-bold text-gray-900 sm:text-4xl">Guide feedback insights</h1>
      <p class="max-w-3xl text-gray-600">
        Track how guests are responding to each guide. These stats update instantly whenever someone submits a like, dislike, or private note about their ride.
      </p>
    </header>

    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      <div class="rounded-3xl border border-[#D5F0C1] bg-white/90 p-6 shadow-lg shadow-[#D5F0C1]/50">
        <p class="text-xs font-semibold uppercase tracking-wide text-[#35605A]">Total likes</p>
        <p class="mt-2 text-3xl font-bold text-gray-900">{{ totals.total_likes|default:0 }}</p>
        <p class="mt-3 text-sm text-gray-500">Moments guests told us they loved a guide.</p>
      </div>
      <div class="rounded-3xl border border-[#F9F7C9] bg-white/90 p-6 shadow-lg shadow-[#F9F7C9]/50">
        <p class="text-xs font-semibold uppercase tracking-wide text-[#7A7310]">Total dislikes</p>
        <p class="mt-2 text-3xl font-bold text-gray-900">{{ totals.total_dislikes|default:0 }}</p>
        <p class="mt-3 text-sm text-gray-500">Flagged experiences that need follow up.</p>
      </div>
      <div class="rounded-3xl border border-[#80BCBD] bg-white/90 p-6 shadow-lg shadow-[#80BCBD]/50 sm:col-span-2 lg:col-span-1">
        <p class="text-xs font-semibold uppercase tracking-wide text-[#35605A]">Private comments</p>
        <p class="mt-2 text-3xl font-bold text-gray-900">{{ totals.total_comments|default:0 }}</p>
        <p class="mt-3 text-sm text-gray-500">Detailed notes from riders about their guide.</p>
      </div>
    </div>

    <div class="rounded-3xl border border-white/60 bg-white/90 p-6 shadow-xl shadow-[#D5F0C1]/60 backdrop-blur">
      <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
        <div>
          <h2 class="text-xl font-semibold text-gray-900">Staff sentiment overview</h2>
          <p class="mt-1 text-sm text-gray-500">Active guides ranked by feedback volume.</p>
        </div>
        <div class="rounded-full border border-[#AAD9BB] bg-[#AAD9BB]/20 px-4 py-1 text-xs font-semibold uppercase tracking-wider text-[#35605A]">
          Updated {{ now|date:"M d, Y H:i" }}
        </div>
      </div>
      <div class="mt-6 overflow-x-auto">
        <table class="min-w-full divide-y divide-[#D5F0C1] text-left text-sm text-gray-700">
          <thead class="bg-[#F9F7C9]/70 text-xs font-semibold uppercase tracking-wide text-[#7A7310]">
            <tr>
              <th scope="col" class="px-4 py-3">Guide</th>
              <th scope="col" class="px-4 py-3">Role</th>
              <th scope="col" class="px-4 py-3 text-center">Likes</th>
              <th scope="col" class="px-4 py-3 text-center">Dislikes</th>
              <th scope="col" class="px-4 py-3 text-center">Comments</th>
              <th scope="col" class="px-4 py-3">Last feedback</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-[#F0F7EA]">
            {% for staff in staff_stats %}
            <tr class="transition hover:bg-[#F9F7C9]/50">
              <td class="px-4 py-3 font-semibold text-gray-900">
                {{ staff.name }}
                {% if staff.nickname %}
                <span class="text-xs font-normal text-gray-500">“{{ staff.nickname }}”</span>
                {% endif %}
              </td>
              <td class="px-4 py-3 text-gray-600">{{ staff.role|default:"—" }}</td>
              <td class="px-4 py-3 text-center font-semibold text-emerald-600">{{ staff.likes_count }}</td>
              <td class="px-4 py-3 text-center font-semibold text-red-500">{{ staff.dislikes_count }}</td>
              <td class="px-4 py-3 text-center text-gray-700">{{ staff.comment_count }}</td>
              <td class="px-4 py-3 text-gray-600">
                {% if staff.latest_feedback %}
                  {{ staff.latest_feedback|date:"M d, Y H:i" }}
                {% else %}
                  <span class="text-gray-400">No feedback yet</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="px-4 py-6 text-center text-gray-500">No staff records found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="grid gap-6 lg:grid-cols-2">
      <div class="rounded-3xl border border-white/60 bg-white/90 p-6 shadow-xl shadow-[#AAD9BB]/60 backdrop-blur">
        <h3 class="text-lg font-semibold text-gray-900">Latest guest notes</h3>
        <p class="mt-1 text-sm text-gray-500">Only team members can see these private comments.</p>
        <div class="mt-5 space-y-4">
          {% if recent_feedback_page %}
            {% for entry in recent_feedback_page %}
            <article class="rounded-2xl border border-[#D5F0C1] bg-white/95 p-4 shadow-sm">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-semibold text-gray-900">{{ entry.staff.name }}</p>
                  <p class="text-xs text-gray-500">{{ entry.created_at|date:"M d, Y H:i" }}</p>
                </div>
                <span class="rounded-full px-3 py-1 text-xs font-semibold {% if entry.sentiment == entry.Sentiment.LIKE %}bg-emerald-100 text-emerald-700{% elif entry.sentiment == entry.Sentiment.DISLIKE %}bg-red-100 text-red-600{% else %}bg-gray-100 text-gray-600{% endif %}">
                  {{ entry.get_sentiment_display }}
                </span>
              </div>
              <p class="mt-3 text-sm text-gray-700 leading-relaxed">{{ entry.comment }}</p>
              <p class="mt-3 text-xs text-gray-400">Submitted by {{ entry.user.get_full_name|default:entry.user.username }}</p>
            </article>
            {% endfor %}
            <nav class="flex items-center justify-between border-t border-[#D5F0C1] pt-4 text-sm text-gray-600">
              <div>
                Showing
                <span class="font-semibold text-gray-900">
                  {{ recent_feedback_page.start_index }}
                </span>
                to
                <span class="font-semibold text-gray-900">
                  {{ recent_feedback_page.end_index }}
                </span>
                of
                <span class="font-semibold text-gray-900">
                  {{ recent_feedback_page.paginator.count }}
                </span>
                comments
              </div>
              <div class="flex items-center gap-2">
                {% if recent_feedback_page.has_previous %}
                <a href="?page={{ recent_feedback_page.previous_page_number }}" class="inline-flex items-center rounded-full border border-[#AAD9BB] px-3 py-1 text-xs font-semibold text-[#35605A] transition hover:bg-[#AAD9BB]/40">
                  Previous
                </a>
                {% else %}
                <span class="inline-flex items-center rounded-full border border-gray-200 px-3 py-1 text-xs text-gray-400">Previous</span>
                {% endif %}
                <span class="text-xs text-gray-500">
                  Page {{ recent_feedback_page.number }} of {{ recent_feedback_page.paginator.num_pages }}
                </span>
                {% if recent_feedback_page.has_next %}
                <a href="?page={{ recent_feedback_page.next_page_number }}" class="inline-flex items-center rounded-full border border-[#AAD9BB] px-3 py-1 text-xs font-semibold text-[#35605A] transition hover:bg-[#AAD9BB]/40">
                  Next
                </a>
                {% else %}
                <span class="inline-flex items-center rounded-full border border-gray-200 px-3 py-1 text-xs text-gray-400">Next</span>
                {% endif %}
              </div>
            </nav>
          {% else %}
          <p class="rounded-2xl border border-dashed border-[#D5F0C1] px-4 py-6 text-center text-sm text-gray-500">No comments yet. Encourage riders to share feedback after each tour.</p>
          {% endif %}
        </div>
      </div>

      <div class="rounded-3xl border border-white/60 bg-white/90 p-6 shadow-xl shadow-[#AAD9BB]/60 backdrop-blur">
        <h3 class="text-lg font-semibold text-gray-900">Tips for follow-up</h3>
        <ul class="mt-4 space-y-3 text-sm text-gray-600">
          <li class="flex gap-3">
            <span class="mt-1 h-2.5 w-2.5 flex-shrink-0 rounded-full bg-[#80BCBD]"></span>
            <p>Schedule coaching sessions with guides who receive more dislikes than likes within the last week.</p>
          </li>
          <li class="flex gap-3">
            <span class="mt-1 h-2.5 w-2.5 flex-shrink-0 rounded-full bg-[#AAD9BB]"></span>
            <p>Highlight guides with consistently high praise in staff meetings and marketing spotlights.</p>
          </li>
          <li class="flex gap-3">
            <span class="mt-1 h-2.5 w-2.5 flex-shrink-0 rounded-full bg-[#F9F7C9]"></span>
            <p>Reach out to guests who left detailed notes to thank them and confirm follow-up actions.</p>
          </li>
        </ul>
        <div class="mt-6 rounded-2xl bg-[#80BCBD]/20 p-4 text-sm text-[#35605A]">
          Need to export feedback? Use the Django admin under “Staff feedbacks” for CSV downloads.
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock content %}
